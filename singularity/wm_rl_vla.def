Bootstrap: docker
From: nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

%labels
  Author RLinf

%environment
  export UV_PATH=/opt/venv
  export HF_HOME=/opt/.cache/huggingface
  export PATH=/opt/venv/openpi/bin:$PATH
  export NVIDIA_DRIVER_CAPABILITIES=all
  export MUJOCO_GL=egl
  export PYOPENGL_PLATFORM=egl
  export MS_SKIP_ASSET_DOWNLOAD_PROMPT=1

%files
  pyproject.toml /tmp/pyproject.toml
  iVideoGPT/requirements.txt /tmp/ivideogpt-requirements.txt

%post
  set -e

  apt-get update && apt-get install -y --no-install-recommends \
      ca-certificates \
      git vim libibverbs-dev openssh-server sudo runit runit-systemd tmux \
      build-essential python3-dev python3-venv cmake pkg-config iproute2 pciutils python3 python3-pip \
      wget unzip curl \
      mesa-utils \
      libosmesa6-dev \
      freeglut3-dev \
      libglew-dev \
      libegl1 \
      libgles2 \
      libglvnd-dev \
      libglfw3-dev \
      libgl1-mesa-dev \
      libgl1-mesa-glx \
      libglib2.0-0 \
      libsm6 \
      libxext6 \
      libxrender-dev \
      libgomp1

  python3 -m pip install --upgrade pip setuptools wheel uv

  mkdir -p /opt/venv /opt/.cache/huggingface
  cp /tmp/pyproject.toml /opt/venv/pyproject.toml
  cd /opt/venv

  cat <<'EOF' > /usr/local/bin/switch_env
#!/bin/bash
if [ -z "$1" ]; then
    echo "Usage: switch_env <env_name>"
    exit 1
fi
if [ ! -d "/opt/venv/$1" ]; then
    echo "Environment $1 does not exist in /opt/venv."
    exit 1
fi
source /opt/venv/$1/bin/activate
EOF
  chmod +x /usr/local/bin/switch_env

  cat <<'EOF' > /usr/local/bin/link_assets
#!/bin/bash
if [ -d /opt/.maniskill ]; then
    ln -s /opt/.maniskill ~/.maniskill
fi
if [ -d /opt/.sapien ]; then
    ln -s /opt/.sapien ~/.sapien
fi
mkdir -p ~/.cache
if [ -d /opt/.openpi ]; then
    ln -s /opt/.openpi ~/.cache/openpi
fi
EOF
  chmod +x /usr/local/bin/link_assets

  cat <<'EOF' > /usr/local/bin/download_assets
#!/bin/bash

# Download assets for ManiSkill
export MS_ASSET_DIR=/opt/.maniskill
python -m mani_skill.utils.download_asset bridge_v2_real2sim -y
python -m mani_skill.utils.download_asset widowx250s -y

# Download assets for SAPIEN
export PHYSX_VERSION=105.1-physx-5.3.1.patch0
export PHYSX_DIR=/opt/.sapien/physx/$PHYSX_VERSION
mkdir -p "$PHYSX_DIR"
wget -O "$PHYSX_DIR/linux-so.zip" https://github.com/sapien-sim/physx-precompiled/releases/download/$PHYSX_VERSION/linux-so.zip
unzip "$PHYSX_DIR/linux-so.zip" -d "$PHYSX_DIR" && rm "$PHYSX_DIR/linux-so.zip"

# Download assets for OpenPI
export TOKENIZER_DIR=/opt/.openpi/big_vision/
mkdir -p "$TOKENIZER_DIR" && gsutil -m cp -r gs://big_vision/paligemma_tokenizer.model "$TOKENIZER_DIR"
EOF
  chmod +x /usr/local/bin/download_assets

  PYTHON_VERSION=3.11

  uv venv openpi --python=${PYTHON_VERSION}
  source /opt/venv/openpi/bin/activate
  UV_TORCH_BACKEND=auto uv sync --active
  uv sync --extra embodied --active
  GIT_LFS_SKIP_SMUDGE=1 uv pip install git+https://github.com/RLinf/openpi
  uv pip install metaworld==3.0.0
  uv pip uninstall -y pynvml
  cp -r /opt/venv/openpi/lib/python${PYTHON_VERSION}/site-packages/openpi/models_pytorch/transformers_replace/* \
      /opt/venv/openpi/lib/python${PYTHON_VERSION}/site-packages/transformers/
  deactivate

  uv venv ivideogpt --python=${PYTHON_VERSION}
  source /opt/venv/ivideogpt/bin/activate
  UV_TORCH_BACKEND=auto uv pip install -r /tmp/ivideogpt-requirements.txt
  deactivate

  git clone -b master --depth 1 https://github.com/RLinf/LIBERO.git /opt/libero

  rm -rf /var/lib/apt/lists/*

%runscript
  exec /bin/bash "$@"
